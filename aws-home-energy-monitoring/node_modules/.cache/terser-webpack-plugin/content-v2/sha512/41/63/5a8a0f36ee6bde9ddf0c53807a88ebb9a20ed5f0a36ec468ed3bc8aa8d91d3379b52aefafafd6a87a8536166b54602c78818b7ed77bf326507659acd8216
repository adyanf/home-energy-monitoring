{"code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(r){if(t[r])return t[r].exports;var a=t[r]={i:r,l:!1,exports:{}};return e[r].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=e,n.c=t,n.d=function(e,t,r){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(n.r(r),Object.defineProperty(r,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var a in e)n.d(r,a,function(t){return e[t]}.bind(null,a));return r},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=3)}([function(e,t){e.exports.config={deviceName:\"xd-home-energy-monitor-2\",dynamoDb:{table:process.env.DYNAMO_DB_TABLE},s3:{bucket:process.env.S3_STORAGE_BUCKET}}},function(e,t,n){const r=n(6);e.exports.dynamoDocClient=new r.DynamoDB.DocumentClient({region:\"us-east-1\"}),e.exports.s3=new r.S3},function(e,t,n){e.exports.getYesterdayDate=function(){const e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setDate(e.getDate()-1);const t=e.toISOString().substring(0,10).replace(/-/g,\"\");return{dateObj:e,unixTimestamp:parseInt(e.getTime()/1e3),string:t,year:t.substring(0,4),month:t.substring(4,6),day:t.substring(6,8)}},e.exports.getTodaysDate=function(){const e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0);const t=e.toISOString().substring(0,10).replace(/-/g,\"\");return{dateObj:e,unixTimestamp:parseInt(e.getTime()/1e3),string:t,year:t.substring(0,4),month:t.substring(4,6),day:t.substring(6,8)}},e.exports.parseDynamoDBReadingsToJson=function(e){const t=[];for(const n of e.Items){n.sortkey;const e=n.readings;let r=n.sortkey-e.length-2;for(const n of e)t.push({timestamp:r,reading:n}),r++}return t},e.exports.parseDynamoDBItemsToCSV=function(t){let n=\"Timestamp,Watts\\n\";const r=e.exports.parseDynamoDBReadingsToJson(t);for(const e of r)n+=e.timestamp+\",\"+e.reading+\"\\n\";return n},e.exports.getReadingsFromDynamoDBSince=async function(t,r){const{dynamoDocClient:a}=n(1),{config:o}=n(0),s=await a.query({TableName:o.dynamoDb.table,KeyConditionExpression:\"#key = :key and #sortkey > :timestamp\",ScanIndexForward:!0,ConsistentRead:!1,ExpressionAttributeNames:{\"#key\":\"primarykey\",\"#sortkey\":\"sortkey\"},ExpressionAttributeValues:{\":key\":\"reading-\"+t,\":timestamp\":r}}).promise();return e.exports.parseDynamoDBReadingsToJson(s)},e.exports.getUsageDataFromDynamoDB=async function(e,t,r){const{dynamoDocClient:a}=n(1),{config:o}=n(0),s=await a.query({TableName:o.dynamoDb.table,KeyConditionExpression:\"#key = :key and #sortkey BETWEEN :start AND :end\",ScanIndexForward:!0,ConsistentRead:!1,ExpressionAttributeNames:{\"#key\":\"primarykey\",\"#sortkey\":\"sortkey\"},ExpressionAttributeValues:{\":key\":\"summary-day-\"+e,\":start\":t,\":end\":r}}).promise();return console.log(s),s.Items},e.exports.writeToS3=async function(e,t){const{s3:r}=n(1),{config:a}=n(0),o=n(7),s=n(8),i=o.promisify(s.gzip),u=await i(t);return r.putObject({Body:u,Bucket:a.s3.bucket,Key:e+\".gz\"}).promise()},e.exports.readFromS3=function(e){const{s3:t}=n(1),{config:r}=n(0);return t.getObject({Bucket:r.s3.bucket,Key:e}).promise()},e.exports.getDatesBetween=function(e,t){const n=[];let r=e;for(;r<=t;)n.push(new Date(r)),r=r.addDays(1);return n},e.exports.writeToDynamoDB=function(e,t){const{dynamoDocClient:r}=n(1);return r.put({TableName:e,Item:t}).promise()}},function(e,t,n){const{graphql:r,buildSchema:a}=n(4),{realtime:o}=n(5),{usageData:s}=n(9),{stats:i}=n(10),u=a(\"\\n  type Query {\\n    usageData(startDate: Int!, endDate: Int!): [DailySummary]!\\n\\n    stats: Stats!\\n\\n    realtime(sinceTimestamp: Int!): [Reading]!\\n\\n    readings(startDate: Int!, endDate: Int!): [Reading]!\\n  }\\n\\n  type Stats{\\n    always_on: Float\\n    today_so_far: Float\\n  }\\n\\n  type Reading {\\n    timestamp: Int!\\n    reading: Int!\\n  }\\n\\n  type DailySummary{\\n    timestamp: Int!\\n    dayUse: Float!\\n    nightUse: Float!\\n  }\\n\"),c={usageData:s,realtime:o,stats:i};e.exports.handler=async function(e,t,n){const a=e.body,o=await r(u,a,c);return{statusCode:200,headers:{\"Content-Type\":\"application/json\",\"Access-Control-Allow-Origin\":\"*\",\"Access-Control-Allow-Credentials\":!0},body:JSON.stringify(o)}}},function(e,t){e.exports=require(\"graphql/index\")},function(e,t,n){const{getReadingsFromDynamoDBSince:r}=n(2),{config:a}=n(0);e.exports.realtime=async({sinceTimestamp:e})=>{const t=new Date/1e3-86400;if(e&&e<t)throw new Error(\"This endpoint can only return data from the last 24 hours\");return e||(console.log(\"No timestamp provided, going default\"),e=new Date/1e3-60),await r(a.deviceName,e)}},function(e,t){e.exports=require(\"aws-sdk\")},function(e,t){e.exports=require(\"util\")},function(e,t){e.exports=require(\"zlib\")},function(e,t,n){const{getUsageDataFromDynamoDB:r}=n(2),{config:a}=n(0);e.exports.usageData=async({startDate:e,endDate:t})=>(await r(a.deviceName,e,t)).map(e=>({timestamp:e.sortkey,dayUse:e.usage.day,nightUse:e.usage.night}))},function(e,t,n){const r=n(11),{getReadingsFromDynamoDBSince:a,getTodaysDate:o}=n(2),{calculateKWH:s}=n(12),i=n(14).jStat,{config:u}=n(0);e.exports.stats=async({sinceTimestamp:e},t,n)=>{new Date;const c=o().unixTimestamp,l=r(n),d={},m=await a(u.deviceName,c);if(l.always_on){const e=m.map(e=>e.reading),t=i.mode(e);d.always_on=t}if(l.today_so_far){const e=m.map(e=>[new Date(1e3*e.timestamp),e.reading]),t=s(e);d.today_so_far=t.day+t.night}return d}},function(e,t,n){\"use strict\";function r(){return(r=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function a(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);\"function\"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){o(e,t,n[t])}))}return e}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s={};function i(e,t){return e.arguments.map((function(e){var n=function e(t,n){switch(t.kind){case\"FloatValue\":return parseFloat(t.value);case\"IntValue\":return parseInt(t.value,10);case\"Variable\":return n.variableValues[t.name.value];case\"ListValue\":return t.values.map((function(t){return e(t,n)}));case\"ObjectValue\":return t.fields.reduce((function(t,r){return t[r.name.value]=e(r.value,n),t}),{});default:return t.value}}(e.value,t);return o({},e.name.value,{kind:e.value.kind,value:n})}))}function u(e,t){var n=e.arguments[0];return\"Variable\"!==n.value.kind?!!n.value.value:t.variableValues[n.value.name.value]}function c(e,t,n){return n=n||{},function(e){return e&&e.selectionSet&&e.selectionSet.selections&&e.selectionSet.selections.length?e.selectionSet.selections:[]}(e).reduce((function(e,n){if(n.directives&&n.directives.length){var o=function(e,t){return e.directives.reduce((function(e,n){switch(n.name.value){case\"include\":return a({},e,{shouldInclude:u(n,t)});case\"skip\":return a({},e,{shouldSkip:u(n,t)});default:return e}}),{shouldInclude:!0,shouldSkip:!1})}(n,t),l=o.shouldInclude;if(o.shouldSkip||!l)return e}if(function(e){return\"InlineFragment\"===e.kind||\"FragmentSpread\"===e.kind}(n))e=c(function(e,t){if(\"FragmentSpread\"===e.kind){var n=e.name.value;return t.fragments[n]}return e}(n,t),t,e);else{var d=n.name.value;if(-1!==s.excludedFields.indexOf(d))return e;e[d]&&\"__arguments\"!==e[d]?r(e[d],c(n,t,e[d])):e[d]=c(n,t),s.processArguments&&n.arguments&&n.arguments.length&&r(e[d],{__arguments:i(n,t)})}return e}),n)}e.exports=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{processArguments:!1},r=e.fieldNodes||e.fieldASTs;return s.processArguments=n.processArguments,s.excludedFields=n.excludedFields||[],r.reduce((function(t,n){return c(n,e,t)}),t)||{}}},function(e,t,n){e.exports.calculateKWH=function(e){const{isNightTarif:t}=n(13),r={day:0,night:0};for(let n=0;n<e.length-1;n++){const a=e[n],o=(e[n+1][0].getTime()-a[0].getTime())/1e3,s=a[1]*o*(1/3600)/1e3;t(a[0])?r.night+=s:r.day+=s}return r}},function(e,t){e.exports.isNightTarif=function(e){return\"number\"==typeof e&&(e=new Date(1e3*e)),e.getHours()>=21&&e.getHours()<=23||e.getHours()>=0&&e.getHours()<=5||(0===e.getDay()||6===e.getDay())}},function(e,t){e.exports=require(\"jStat\")}]));","extractedComments":[]}