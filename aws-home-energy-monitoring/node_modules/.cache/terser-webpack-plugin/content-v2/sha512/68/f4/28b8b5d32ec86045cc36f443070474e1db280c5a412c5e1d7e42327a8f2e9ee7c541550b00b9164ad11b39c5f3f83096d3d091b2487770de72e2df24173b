{"code":"!function(e,t){for(var n in t)e[n]=t[n]}(exports,function(e){var t={};function n(o){if(t[o])return t[o].exports;var r=t[o]={i:o,l:!1,exports:{}};return e[o].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,o){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:o})},n.r=function(e){\"undefined\"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:\"Module\"}),Object.defineProperty(e,\"__esModule\",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&\"object\"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(n.r(o),Object.defineProperty(o,\"default\",{enumerable:!0,value:e}),2&t&&\"string\"!=typeof e)for(var r in e)n.d(o,r,function(t){return e[t]}.bind(null,r));return o},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,\"a\",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p=\"\",n(n.s=2)}([function(e,t,n){const o=n(3);e.exports.dynamoDocClient=new o.DynamoDB.DocumentClient({region:\"us-east-1\"}),e.exports.s3=new o.S3},function(e,t){e.exports.config={deviceName:\"xd-home-energy-monitor-2\",dynamoDb:{table:process.env.DYNAMO_DB_TABLE},s3:{bucket:process.env.S3_STORAGE_BUCKET}}},function(e,t,n){\"use strict\";const{dynamoDocClient:o}=n(0),{config:r}=n(1),{getYesterdayDate:s,getTodaysDate:a,writeToS3:i,writeToDynamoDB:u,parseDynamoDBItemsToCSV:c}=n(4),{calculateKWH:y}=n(7),m=r.deviceName;e.exports.handler=async(e,t,n)=>{const p=await async function(){console.time(\"[PERF] Get history data\");try{const e=s().unixTimestamp,t=a().unixTimestamp,n=\"reading-\"+m,i=await o.query({TableName:r.dynamoDb.table,KeyConditionExpression:\"#key = :key and #sortKey BETWEEN :start AND :end\",ScanIndexForward:!0,ConsistentRead:!1,ExpressionAttributeNames:{\"#key\":\"primarykey\",\"#sortKey\":\"sortkey\"},ExpressionAttributeValues:{\":key\":n,\":start\":e,\":end\":t}}).promise();return console.timeEnd(\"[PERF] Get history data\"),console.log(\"Item count for yesterday\",i.Items.length),i}catch(e){return console.log(\"Error fetching historical data\"),console.log(e),{Items:[]}}}(),d=c(p),l=s();await i(`archived-readings/${m}/${l.year}/${l.month}/${l.string}.csv`,d);const g=function(e){const t=[];for(const n of e.split(\"\\n\")){if(\"\"===n)continue;const e=n.split(\",\");\"Timestamp\"!==e[0]&&t.push([new Date(1e3*parseInt(e[0])),parseInt(e[1])])}return y(t)}(d);console.log(\"usage data\",g),await async function(e){const t=\"[PERF] Write daily summary to DynamoDB\";console.time(t);try{const n=\"summary-day-\"+m,o=s().unixTimestamp,a=await u(r.dynamoDb.table,{primarykey:n,sortkey:o,usage:e});return console.timeEnd(t),a}catch(e){return console.log(\"Error writing daily usage to DynamoDB:\"),console.log(e),!1}}(g)}},function(e,t){e.exports=require(\"aws-sdk\")},function(e,t,n){e.exports.getYesterdayDate=function(){const e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0),e.setDate(e.getDate()-1);const t=e.toISOString().substring(0,10).replace(/-/g,\"\");return{dateObj:e,unixTimestamp:parseInt(e.getTime()/1e3),string:t,year:t.substring(0,4),month:t.substring(4,6),day:t.substring(6,8)}},e.exports.getTodaysDate=function(){const e=new Date;e.setHours(0),e.setMinutes(0),e.setSeconds(0);const t=e.toISOString().substring(0,10).replace(/-/g,\"\");return{dateObj:e,unixTimestamp:parseInt(e.getTime()/1e3),string:t,year:t.substring(0,4),month:t.substring(4,6),day:t.substring(6,8)}},e.exports.parseDynamoDBReadingsToJson=function(e){const t=[];for(const n of e.Items){n.sortkey;const e=n.readings;let o=n.sortkey-e.length-2;for(const n of e)t.push({timestamp:o,reading:n}),o++}return t},e.exports.parseDynamoDBItemsToCSV=function(t){let n=\"Timestamp,Watts\\n\";const o=e.exports.parseDynamoDBReadingsToJson(t);for(const e of o)n+=e.timestamp+\",\"+e.reading+\"\\n\";return n},e.exports.getReadingsFromDynamoDBSince=async function(t,o){const{dynamoDocClient:r}=n(0),{config:s}=n(1),a=await r.query({TableName:s.dynamoDb.table,KeyConditionExpression:\"#key = :key and #sortkey > :timestamp\",ScanIndexForward:!0,ConsistentRead:!1,ExpressionAttributeNames:{\"#key\":\"primarykey\",\"#sortkey\":\"sortkey\"},ExpressionAttributeValues:{\":key\":\"reading-\"+t,\":timestamp\":o}}).promise();return e.exports.parseDynamoDBReadingsToJson(a)},e.exports.getUsageDataFromDynamoDB=async function(e,t,o){const{dynamoDocClient:r}=n(0),{config:s}=n(1),a=await r.query({TableName:s.dynamoDb.table,KeyConditionExpression:\"#key = :key and #sortkey BETWEEN :start AND :end\",ScanIndexForward:!0,ConsistentRead:!1,ExpressionAttributeNames:{\"#key\":\"primarykey\",\"#sortkey\":\"sortkey\"},ExpressionAttributeValues:{\":key\":\"summary-day-\"+e,\":start\":t,\":end\":o}}).promise();return console.log(a),a.Items},e.exports.writeToS3=async function(e,t){const{s3:o}=n(0),{config:r}=n(1),s=n(5),a=n(6),i=s.promisify(a.gzip),u=await i(t);return o.putObject({Body:u,Bucket:r.s3.bucket,Key:e+\".gz\"}).promise()},e.exports.readFromS3=function(e){const{s3:t}=n(0),{config:o}=n(1);return t.getObject({Bucket:o.s3.bucket,Key:e}).promise()},e.exports.getDatesBetween=function(e,t){const n=[];let o=e;for(;o<=t;)n.push(new Date(o)),o=o.addDays(1);return n},e.exports.writeToDynamoDB=function(e,t){const{dynamoDocClient:o}=n(0);return o.put({TableName:e,Item:t}).promise()}},function(e,t){e.exports=require(\"util\")},function(e,t){e.exports=require(\"zlib\")},function(e,t,n){e.exports.calculateKWH=function(e){const{isNightTarif:t}=n(8),o={day:0,night:0};for(let n=0;n<e.length-1;n++){const r=e[n],s=(e[n+1][0].getTime()-r[0].getTime())/1e3,a=r[1]*s*(1/3600)/1e3;t(r[0])?o.night+=a:o.day+=a}return o}},function(e,t){e.exports.isNightTarif=function(e){return\"number\"==typeof e&&(e=new Date(1e3*e)),e.getHours()>=21&&e.getHours()<=23||e.getHours()>=0&&e.getHours()<=5||(0===e.getDay()||6===e.getDay())}}]));","extractedComments":[]}